povoプロモコード管理アプリ 要件定義書 完全版

版情報
本書は、Windows 11上で動作するElectronとTypeScriptによるデスクトップアプリケーションの要件を定義する。対象はpovo 2.0のプロモコード運用であり、Androidのpovo公式アプリで実施するコード入力そのものを自動化せず、コード台帳と期限管理と通知によって運用事故を防ぐことに集中する。

第一章 背景
povo 2.0のプロモコードはメールで送付され、利用者はAndroidのpovo公式アプリでコードを貼り付けて適用する。まとめ買いの運用では複数コードを手元に保持し、途切れなく回線を維持したい意図が生まれる一方で、次にどのコードを使うべきか、どれが未使用でどれが使用済みか、現在の有効期間がいつ終わるか、未使用のまま公式の入力期限を過ぎていないか、といった管理が煩雑になりやすい。本アプリはこの管理をWindows 11上で完結させ、通知を通じて期限切れと回線途切れのリスクを最小化する。

第二章 目的と最重要ゴール
目的は、第一に期限切れ管理を確実にすること、第二に使ったコードと未使用コードを確実に区別できること、第三に残回数を正確に把握できることである。ここでいう期限切れは、未使用のまま公式のコード入力期限を迎えた状態を指す。回線維持のために次コードを途切れなく開始したいという動機は別概念として扱い、運用上の目安として可視化と通知の対象に含める。

第三章 対象範囲と非対象
対象OSはWindows 11のみとし、アプリは通常のウィンドウアプリとして提供し、ダークテーマに対応する。管理対象は現時点ではデータ使い放題 7日間 12回分のうちメールに届く11個のコードを中心とし、ほかのトッピングや24回分などの別商品は本書の必須要件に含めない。ただし、メール本文から抽出できる有効期間が1時間など別の長さであってもデータモデルは破綻しない構造とし、拡張の余地を残す。Android端末操作の自動化、povoアカウント連携、メールの自動取得、購入自動化、複数回線プロファイル、統計分析やコスト集計は非対象とする。

第四章 用語定義
本書でいうコードとは、povo公式アプリに貼り付けて適用するプロモコード文字列を指す。コード入力期限とは、メールに記載されるコード入力期限の日時であり、その日時を過ぎるとコードの入力ができなくなると想定する。使用開始とは、ユーザーがAndroid側で当該コードを実際に適用した事実をWindows側アプリに反映させる操作である。有効期間とは、使用開始から所定の期間だけ通信が使い放題になる期間を指す。有効期限とは、使用開始日時に有効期間を加算した利用終了時刻を指す。連続カバレッジとは、現在時刻を起点として、使用中コード群の有効期間の連結により途切れなくカバーされる時間帯の終端を指す。運用締切とは、回線を途切れさせないために次コードを開始すべき目安であり、連続カバレッジ終端と同義として扱う。状態とは、未使用、使用中、消費済み、期限切れの四つを指す。

第五章 状態モデルと判定規則
未使用とは、使用開始日時が設定されておらず、現在時刻がコード入力期限以前である状態である。使用中とは、使用開始日時が設定されており、現在時刻が有効期限以前である状態である。消費済みとは、使用開始日時が設定されており、現在時刻が有効期限を過ぎている状態である。期限切れとは、使用開始日時が未設定のまま現在時刻がコード入力期限を過ぎている状態である。状態判定は常に自動で行い、手動で状態を直接編集させない。手動で許可するのは使用開始日時の編集と取り消しのみであり、その結果として状態が再計算される。コード入力期限を過ぎた使用開始済みコードは期限切れではなく消費済みまたは使用中として扱う。

第六章 同時並行の許容
本アプリは、複数のコードが時間的に被る形で同時並行に使用中となる可能性を許容する。使用中が同時に複数存在しても良い。これにより、Android側の適用タイミングの重なりや、運用上の余裕を持たせるための重ね掛けを支援する。

第七章 連続カバレッジの定義と計算
連続カバレッジは、使用中の各コードの時間区間を使用開始日時から有効期限までの閉区間として扱い、現在時刻を含む区間群から右方向に連結できる範囲を連続カバレッジとして求める。区間の終端と別区間の開始が同一時刻である場合は連続とみなす。区間同士が重なる場合も連続とみなす。区間の終端と次区間の開始時刻が離れており、離れた時間にギャップが生じる場合のみ非連続と判定する。連続カバレッジが存在しない場合、現在のカバレッジはないと表示し、回線が途切れている可能性が高いことを明示する。連続カバレッジが存在する場合、終端時刻と残り時間を最重要情報として表示し、ギャップが生じる場合はギャップ開始時刻を回線が途切れる予測時刻として強調する。

第八章 次に開始すべきコード候補の定義
次に開始すべきコード候補は、未使用かつ期限切れではないコードのうち、登録順序が最も早いものを第一候補として提示する。ここでいう登録順序は、メール本文貼り付けから抽出された出現順を基本とし、ユーザーが並べ替えた結果を最終順序として尊重する。メールがHTMLの表形式で届く場合があり、コピペ時に段組情報が失われる可能性が高いことを前提に、抽出は行単位の走査によって得たコード列を出現順で採番し、これを順序の初期値とする。複数の候補が同順位となる状況は原則発生しないが、発生した場合は内部IDの昇順で安定して選ぶ。

第九章 画面構成
画面はタブ構成を採用し、概略タブ、コード一覧タブ、登録タブ、編集取り消しタブ、通知タブを持つ。起動時は概略タブを表示する。

第十章 概略タブの要件
概略タブは、現在の連続カバレッジ終端と残り時間を最優先で表示する。次に、次に開始すべきコード候補を表示し、ユーザーが迷わず開始できるようにする。さらに、使用中コードが複数ある場合は、使用中コードの要約として各コードの有効期限と残り時間を表示する。使用中が存在しない場合は現在のカバレッジがないことを表示し、次に開始すべき候補を提示する。表示は分単位で更新されることが望ましく、少なくとも60秒に1回は自動再計算して表示を更新する。

第十一章 コード一覧タブの要件
コード一覧タブは全コードを一覧表示し、順序、コード文字列、状態、コード入力期限、使用開始日時、有効期限を表示する。コード文字列は既定で一部をマスク表示し、ユーザー操作により一時的に全表示できる。フィルターとして状態フィルターと入力期限フィルターを提供する。入力期限フィルターはコード入力期限を対象とし、期限が近いものを絞り込めることが望ましい。並び順は既定で順序の昇順とし、別途、コード入力期限の昇順や状態別の切り替えを提供してもよいが、MVPでは順序の昇順が最優先である。

第十二章 登録タブの要件
登録タブはメール本文の貼り付けを受け付け、そこからコード文字列とコード入力期限と有効期間を抽出し、プレビューを提示した上で登録する。抽出に失敗した場合でも手入力で登録できる。抽出は段組情報の喪失を前提に、テキストを上から下へ走査し、見出しと値の近接関係により推定する。例として、データ使い放題ボーナスの行に続く次行の英数字列をコードとみなし、コードの入力期限の行に続く次行の日付をコード入力期限とみなす。日付は日本語表記のYYYY年M月D日（曜）を解釈でき、曜日部分は無視してよい。例メールからは、コードがUL1H97X3CKAR6であり、コード入力期限が2026年6月20日であることを抽出できる必要がある。有効期間は見出し中の括弧表現から抽出し、1時間や7日間を分単位に正規化して保持する。登録直後の状態は未使用であり、使用開始日時と有効期限は未設定である。登録時に順序を自動採番し、初期順序は抽出されたコードの出現順と一致させる。登録後に順序の並べ替えができる。

第十三章 編集取り消しタブの要件
編集取り消しタブは、コードを選択して使用開始と時刻編集と取り消しを提供する。使用開始操作により使用開始日時が現在時刻で設定され、有効期限が使用開始日時と有効期間から計算される。Android側での実開始時刻とずれた場合に備え、使用開始日時を手動編集でき、その結果として有効期限と通知が再計算される。取り消し操作は、使用開始日時と有効期限を未設定に戻し、未使用として扱う。取り消しは誤操作防止のため確認を要求する。

第十四章 通知タブの要件
通知は二系統を扱う。第一は利用終了通知であり、使用中コードの有効期限に対して既定で24時間前、3時間前、1時間前、30分前にWindows通知を出す。第二は公式入力期限通知であり、コード入力期限に対して通知を出すが、既定はオフとし、ユーザーが必要に応じて閾値を追加できる。通知タブでは各閾値の有効無効と時間を変更でき、任意のタイミングでテスト通知を出せる。通知対象は、利用終了通知は使用中のコードに限定し、公式入力期限通知は未使用のコードに限定する。アプリが起動していない場合の通知保証はMVP要件に含めず、アプリ起動中に確実に通知されることを必須とする。

第十五章 自動更新と判定タイミング
状態判定と通知スケジューリングは、起動時、データ読み込み時、登録確定時、使用開始確定時、時刻編集確定時、取り消し確定時に必ず再計算する。さらに、アプリ起動中は一定間隔で再計算し、使用中から消費済みへの遷移、未使用から期限切れへの遷移、連続カバレッジの変化を反映する。

第十六章 永続化とデータ設計
保存はローカル平文で良く、暗号化や起動パスコードは不要とする。コード単位のデータは、内部ID、順序、コード文字列、コード入力期限、有効期間、使用開始日時、有効期限を保持する。状態は保持せず計算結果として扱う。使用開始日時と有効期限は未使用および期限切れでは未設定を許容する。有効期間は分単位の整数を基本とし、1時間は60、7日間は10080として扱う。

第十七章 エクスポートとインポート
エクスポートは全データを単一JSONに出力し、ユーザーが任意の場所へ保存できる。インポートはJSONを読み込み、既存データを置換する方式を基本とする。置換前に自動バックアップを作成し、復旧可能とする。JSONにはバージョン番号を含め、将来拡張に備える。

第十八章 エラーハンドリング
メール貼り付け抽出でコードが抽出できない場合は抽出失敗を明示し、手入力登録を案内する。抽出候補が複数生じた場合は出現順と見出し近接を優先して推定しつつ、最終的にユーザーが確定できるUIを提供する。日付パースに失敗した場合は未設定として登録を許容するのではなく、登録確定を止めて入力を求める。時刻編集により有効期限が過去になるなど矛盾が生じても許容し、その結果として状態が消費済みになることを明示する。

第十九章 受け入れ条件
ユーザーがメール本文を貼り付けて複数コードを抽出し、出現順に順序付けられた未使用コードとして登録できること。各コードが一覧で状態判定され、未使用、使用中、消費済み、期限切れが定義通りに自動的に反映されること。任意のコードに使用開始を適用すると使用開始日時と有効期限が計算され、概略タブに連続カバレッジ終端と残り時間が表示されること。複数コードが同時に使用中となっても連続カバレッジが正しく計算され、ギャップがある場合に警告が出ること。利用終了通知が既定の閾値で発火し、テスト通知が送れること。使用開始日時を編集すると表示と通知が再計算され、取り消しで未使用に戻せること。JSONでエクスポートし、インポートで同一状態が再現できること。以上を満たすことでMVPを受け入れ可能とする。

第二十章 リポジトリ名
リポジトリ名の仮称はpovo-promo-code-notifyとする。

以上
